services:
  fdb-test:
    container_name: fdb-test
    image: ghcr.io/melgenek/f8n/foundationdb:7.3.69
    post_start:
     - command: >
        bash -c '
          while [ ! -f /var/fdb/fdb.cluster ]; do
            sleep 0.1
          done
          if ! fdbcli --exec status --timeout 3 ; then
            echo "creating the database"
            if ! fdbcli --exec "configure new single ssd ; status" --timeout 10 ; then
                echo "Unable to configure new FDB cluster."
                exit 1
            elif ! fdbcli --exec "configure single ssd ; status" --timeout 10 ; then
                echo "Unable to configure existing FDB cluster."
                exit 1
            fi
          fi
        '
  tests:
    image: golang:1.24
    build:
      context: ./../..
      dockerfile: Dockerfile
      target: base
    environment:
      FDB_CONNECTION_STRING: "docker:docker@fdb-test:4500"
    command: go test ./...
